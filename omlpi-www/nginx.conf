
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    client_max_body_size 50M; # subindo limite do upload para 50MB

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
    '$status $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    sendfile on;
    tcp_nopush on;

    keepalive_timeout 120;

    server {
        # Block access to all locations, except the ones defined below
        # this avoids exposing the server to the internet using the IP address
        location / {
            return 403;
        }
    }

    server {

        server_name tmp--omlpi-strapi.appcivico.com omlpi-strapi.rnpiobserva.org.br;
        listen 80;

        proxy_read_timeout 60s;
        proxy_send_timeout 110s;

        # Strapi
        location / {

            set $cors "1";

            # OPTIONS indicates a CORS pre-flight request
            if ($request_method = 'OPTIONS') {
                set $cors "${cors}o";
            }

            # Append CORS headers to any request from
            # allowed CORS domain, except OPTIONS
            if ($cors = "1") {
                more_set_headers 'Access-Control-Allow-Origin: $http_origin';
                more_set_headers 'Access-Control-Allow-Credentials: true';
            }

            # OPTIONS (pre-flight) request from allowed
            # CORS domain. return response directly
            if ($cors = "1o") {
                more_set_headers 'Access-Control-Allow-Origin: $http_origin';
                more_set_headers 'Access-Control-Allow-Methods: GET, POST, OPTIONS, PUT, DELETE';
                more_set_headers 'Access-Control-Allow-Credentials: true';
                more_set_headers 'Access-Control-Allow-Headers: Origin,Content-Type,Accept,X-API-Key,baggage,sentry-trace';
                more_set_headers 'Vary: Origin';
                more_set_headers 'Access-Control-Max-Age: 600';

                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }

            more_set_headers 'x-extra' '';
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;

            proxy_redirect off;
            proxy_pass http://172.17.0.1:4139;
        }

        location /artigos {


            set $cors "1";

            # OPTIONS indicates a CORS pre-flight request
            if ($request_method = 'OPTIONS') {
                set $cors "${cors}o";
            }

            # Append CORS headers to any request from
            # allowed CORS domain, except OPTIONS
            if ($cors = "1") {
                more_set_headers 'Access-Control-Allow-Origin: $http_origin';
                more_set_headers 'Access-Control-Allow-Credentials: true';
            }

            # OPTIONS (pre-flight) request from allowed
            # CORS domain. return response directly
            if ($cors = "1o") {
                more_set_headers 'Access-Control-Allow-Origin: $http_origin';
                more_set_headers 'Access-Control-Allow-Methods: GET, POST, OPTIONS, PUT, DELETE';
                more_set_headers 'Access-Control-Allow-Credentials: true';
                more_set_headers 'Access-Control-Allow-Headers: Origin,Content-Type,Accept,X-API-Key,baggage,sentry-trace';
                more_set_headers 'Vary: Origin';
                more_set_headers 'Access-Control-Max-Age: 600';

                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }

            more_set_headers 'x-extra' '';
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;

            proxy_redirect off;
            proxy_pass http://172.17.0.1:4137;
        }


    }


}
